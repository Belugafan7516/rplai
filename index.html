<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rugplay Market Analytics</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Cloudflare Turnstile -->
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js?render=explicit"></script>

    <!-- Import Map -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "recharts": "https://esm.sh/recharts@2.12.2?deps=react@18.2.0,react-dom@18.2.0",
            "lucide-react": "https://esm.sh/lucide-react@0.344.0?deps=react@18.2.0"
        }
    }
    </script>

    <!-- Custom Styles -->
    <style>
        body { background-color: #020617; color: white; font-family: sans-serif; overflow-x: hidden; }
        #root { min-height: 100vh; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        
        .ticker-wrap {
            width: 100%;
            overflow: hidden;
            background-color: #0f172a;
            border-bottom: 1px solid #1e293b;
            height: 30px;
            display: flex;
            align-items: center;
        }
        .ticker {
            display: inline-block;
            white-space: nowrap;
            animation: ticker 30s linear infinite;
        }
        @keyframes ticker {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }
        
        #emergency-reset {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 9999;
            background: #7f1d1d;
            color: #fca5a5;
            border: 1px solid #ef4444;
            padding: 5px 10px;
            font-size: 10px;
            border-radius: 4px;
            cursor: pointer;
            opacity: 0.5;
            transition: opacity 0.2s;
        }
        #emergency-reset:hover { opacity: 1; }
    </style>
</head>
<body>
    <button id="emergency-reset" onclick="if(confirm('Clear all data and reload?')){localStorage.clear();window.location.reload();}">Reset App Data</button>

    <div id="root">
        <div style="height: 100vh; display: flex; align-items: center; justify-content: center; color: #64748b;">
            Loading Rugplay Analytics...
        </div>
    </div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useMemo } from 'react';
        import ReactDOM from 'react-dom/client';
        
        import { 
            ComposedChart, Area, Bar, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, ReferenceLine, Cell, PieChart, Pie
        } from 'recharts';

        import { 
            TrendingUp, Activity, AlertTriangle, Search, Zap, Brain, Lock, RefreshCw, 
            BarChart2, X, Globe, Star, Filter, ArrowUpDown, Sparkles, ShieldCheck, Key, ShieldAlert, CheckCircle, Cpu, Wallet, DollarSign, Briefcase, History, Trash2
        } from 'lucide-react';

        // --- SAFE STORAGE PARSER ---
        const safeJSONParse = (key, fallback) => {
            try {
                const item = localStorage.getItem(key);
                if (item === null || item === "undefined") return fallback;
                return JSON.parse(item);
            } catch (e) {
                console.warn(`[Storage] Failed to parse ${key}, resetting.`);
                return fallback;
            }
        };

        // --- CONFIGURATION ---
        const TURNSTILE_SITE_KEY = "0x4AAAAAACZBwcHHoM4nJcWq"; 
        const REQUEST_LIMIT = 15;
        const COLORS = ['#10b981', '#6366f1', '#f59e0b', '#ef4444', '#ec4899', '#8b5cf6', '#06b6d4'];

        // --- COMPONENTS ---

        const NewsTicker = () => {
            const headlines = [
                "BITCOIN CRASHES TO 100K THEN RECOVERS IN 2 SECONDS",
                "ELON MUSK TWEETS A DOG EMOJI, MARKETS CONFUSED",
                "RUGPULL DETECTED IN SECTOR 7G",
                "NEW ATH FOR 'SCAMCOIN' - INVESTORS CELEBRATE",
                "FED ANNOUNCES RATES WILL STAY 'VIBES BASED'",
                "WHALE ALERT: 1000 ETH MOVED TO UNKNOWN WALLET",
                "DEVELOPER FORGETS TO LOCK LIQUIDITY, OOPS",
            ];
            return (
                <div className="ticker-wrap">
                    <div className="ticker text-xs font-mono text-emerald-400">
                        {headlines.join(" +++ ")} +++ {headlines.join(" +++ ")}
                    </div>
                </div>
            );
        };

        const DeploymentBanner = () => {
            const [isVisible, setIsVisible] = useState(true);
            const isLocal = window.location.protocol === 'file:' || 
                            window.location.hostname === 'localhost' || 
                            window.location.hostname === '127.0.0.1';

            if (!isLocal || !isVisible) return null;

            return (
                <div className="bg-amber-500/10 border-b border-amber-500/20 text-amber-200 px-4 py-2 relative text-xs">
                    <div className="max-w-7xl mx-auto flex items-center justify-between">
                        <span className="flex items-center gap-2"><ShieldAlert size={14}/> <strong>Local Mode:</strong> Security features disabled. Deploy to enable Cloudflare Access.</span>
                        <button onClick={() => setIsVisible(false)}><X size={14} /></button>
                    </div>
                </div>
            );
        };

        const OnboardingModal = ({ onComplete }) => {
            const [tempRugplayKey, setTempRugplayKey] = useState('');
            const [tempGeminiKey, setTempGeminiKey] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                if (tempRugplayKey.trim()) {
                    onComplete(tempRugplayKey.trim(), tempGeminiKey.trim());
                } else {
                    alert("Rugplay API Key is required to proceed.");
                }
            };

            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center bg-slate-950/95 backdrop-blur-md p-4 animate-in fade-in duration-500">
                    <div className="bg-slate-900 border border-indigo-500/50 p-8 rounded-2xl max-w-md w-full shadow-2xl relative overflow-hidden">
                        <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-indigo-500 to-purple-600"></div>
                        
                        <div className="flex justify-center mb-6">
                            <div className="bg-indigo-500/20 p-4 rounded-full border border-indigo-500/50">
                                <Activity size={48} className="text-indigo-400" />
                            </div>
                        </div>

                        <h2 className="text-2xl font-bold text-white text-center mb-2">Welcome to Rugplay Analytics</h2>
                        <p className="text-slate-400 text-center mb-8 text-sm">Advanced trade tracking & AI-powered market predictions.</p>

                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="text-xs font-bold text-slate-500 uppercase mb-1 block ml-1">Rugplay API Key (Required)</label>
                                <div className="relative">
                                    <Key className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500" size={16} />
                                    <input 
                                        type="text" 
                                        value={tempRugplayKey} 
                                        onChange={(e) => setTempRugplayKey(e.target.value)} 
                                        placeholder="rgpl_..." 
                                        className="w-full bg-slate-950 border border-slate-800 rounded-lg pl-10 pr-4 py-3 text-sm text-white focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none transition-all"
                                        autoFocus
                                    />
                                </div>
                            </div>

                            <div>
                                <label className="text-xs font-bold text-slate-500 uppercase mb-1 block ml-1">Gemini API Key (Optional)</label>
                                <div className="relative">
                                    <Brain className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500" size={16} />
                                    <input 
                                        type="password" 
                                        value={tempGeminiKey} 
                                        onChange={(e) => setTempGeminiKey(e.target.value)} 
                                        placeholder="AIza..." 
                                        className="w-full bg-slate-950 border border-slate-800 rounded-lg pl-10 pr-4 py-3 text-sm text-white focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none transition-all"
                                    />
                                </div>
                                <p className="text-[10px] text-slate-600 mt-1 ml-1">Required for "AI Deep Scan" features.</p>
                            </div>

                            <button 
                                type="submit" 
                                className="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 text-white font-bold py-3 rounded-lg transition-all transform active:scale-95 mt-4"
                            >
                                Launch Dashboard
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        const RugplayAnalyzer = () => {
            // --- Core State (Loaded from Storage) ---
            const [apiKey, setApiKey] = useState(() => localStorage.getItem('rugplay_api_key') || '');
            const [geminiKey, setGeminiKey] = useState(() => localStorage.getItem('rugplay_gemini_key') || '');
            const [showOnboarding, setShowOnboarding] = useState(() => !localStorage.getItem('rugplay_api_key'));
            
            const proxyUrl = 'https://rplsend.powerstudios.workers.dev/?url=';

            // --- Wallet / Trading State ---
            const [holdings, setHoldings] = useState(() => safeJSONParse('rugplay_holdings', {}));
            const [transactions, setTransactions] = useState(() => safeJSONParse('rugplay_transactions', []));
            const [tradeAmount, setTradeAmount] = useState('');

            // --- UI State ---
            const [activeTab, setActiveTab] = useState('dashboard');
            const [isLoading, setIsLoading] = useState(false);
            const [isDetailLoading, setIsDetailLoading] = useState(false);
            const [isAiLoading, setIsAiLoading] = useState(false);
            const [requestCount, setRequestCount] = useState(0);
            const [showTurnstile, setShowTurnstile] = useState(false);

            // Feature States
            const [searchQuery, setSearchQuery] = useState('');
            const [sortOption, setSortOption] = useState('default');
            const [watchlist, setWatchlist] = useState(() => safeJSONParse('rugplay_watchlist', []));

            // Data
            const [marketData, setMarketData] = useState([]); 
            const [predictionMarkets, setPredictionMarkets] = useState([]); 
            const [selectedItem, setSelectedItem] = useState(null);
            const [chartData, setChartData] = useState([]);
            const [analysisResult, setAnalysisResult] = useState(null);
            const [error, setError] = useState(null);

            // Modals
            const [showResultModal, setShowResultModal] = useState(false);
            const [showErrorModal, setShowErrorModal] = useState(false);

            // --- Persistence ---
            useEffect(() => { localStorage.setItem('rugplay_watchlist', JSON.stringify(watchlist)); }, [watchlist]);
            useEffect(() => { if(apiKey) localStorage.setItem('rugplay_api_key', apiKey); }, [apiKey]);
            useEffect(() => { if(geminiKey) localStorage.setItem('rugplay_gemini_key', geminiKey); }, [geminiKey]);
            useEffect(() => { localStorage.setItem('rugplay_holdings', JSON.stringify(holdings)); }, [holdings]);
            useEffect(() => { localStorage.setItem('rugplay_transactions', JSON.stringify(transactions)); }, [transactions]);

            const handleOnboardingComplete = (rKey, gKey) => {
                setApiKey(rKey);
                setGeminiKey(gKey);
                setShowOnboarding(false);
            };

            const toggleWatchlist = (e, id) => {
                e.stopPropagation();
                setWatchlist(prev => prev.includes(id) ? prev.filter(x => x !== id) : [...prev, id]);
            };

            // --- Helpers ---
            const getUrl = (endpoint) => proxyUrl ? `${proxyUrl}${encodeURIComponent(endpoint)}` : endpoint;
            
            const getHeaders = () => {
                let cleanKey = apiKey.trim();
                if (cleanKey.toLowerCase().startsWith('bearer ')) cleanKey = cleanKey.slice(7).trim();
                return { 'Authorization': `Bearer ${cleanKey}`, 'Accept': 'application/json' };
            };

            const checkRateLimit = () => {
                if (requestCount >= REQUEST_LIMIT) {
                    setShowTurnstile(true);
                    return false;
                }
                setRequestCount(prev => prev + 1);
                return true;
            };

            const handleTurnstileSuccess = () => {
                setTimeout(() => { setRequestCount(0); setShowTurnstile(false); }, 500); 
            };

            // --- Trading Logic ---
            const executeTrade = (action) => {
                if (!selectedItem || selectedItem.type !== 'coin') return;
                const amount = parseFloat(tradeAmount);
                if (isNaN(amount) || amount <= 0) {
                    setError("Please enter a valid USD amount.");
                    setShowErrorModal(true);
                    return;
                }

                const price = parseFloat(selectedItem.price || selectedItem.currentPrice);
                const symbol = selectedItem.symbol;
                const qty = amount / price;

                const newTx = {
                    id: Date.now(),
                    type: action,
                    symbol: symbol,
                    price: price,
                    amount: amount,
                    qty: qty,
                    timestamp: new Date().toLocaleString()
                };

                if (action === 'BUY') {
                    setHoldings(prev => {
                        const currentQty = prev[symbol]?.qty || 0;
                        const currentCost = prev[symbol]?.avgCost || 0;
                        const totalCost = (currentQty * currentCost) + amount;
                        const newTotalQty = currentQty + qty;
                        return { ...prev, [symbol]: { qty: newTotalQty, avgCost: totalCost / newTotalQty } };
                    });
                } else if (action === 'SELL') {
                    const currentHolding = holdings[symbol];
                    if (!currentHolding || qty > currentHolding.qty) {
                        setError(`Insufficient coins! You only hold ${currentHolding?.qty.toFixed(4) || 0} ${symbol}.`);
                        setShowErrorModal(true);
                        return;
                    }
                    
                    setHoldings(prev => {
                        const newQty = prev[symbol].qty - qty;
                        if (newQty <= 0.000001) {
                            const newHoldings = { ...prev };
                            delete newHoldings[symbol];
                            return newHoldings;
                        }
                        return { ...prev, [symbol]: { ...prev[symbol], qty: newQty } };
                    });
                }
                
                setTransactions(prev => [newTx, ...prev]);
                setTradeAmount('');
            };

            const resetPortfolio = () => {
                if(confirm("Clear all holdings and transaction history?")) {
                    setHoldings({});
                    setTransactions([]);
                }
            };

            const getPortfolioStats = () => {
                let investedValue = 0;
                let totalCostBasis = 0;
                const assets = Object.keys(holdings).map(sym => {
                    const coin = marketData.find(c => c.symbol === sym);
                    const currentPrice = coin ? (parseFloat(coin.price || coin.currentPrice)) : (holdings[sym].avgCost);
                    const qty = holdings[sym].qty;
                    const avgCost = holdings[sym].avgCost;
                    const value = qty * currentPrice;
                    const costBasis = qty * avgCost;
                    const pnl = value - costBasis;
                    
                    investedValue += value;
                    totalCostBasis += costBasis;
                    
                    return {
                        symbol: sym,
                        qty,
                        avgCost,
                        currentPrice,
                        value,
                        pnl,
                        pnlPercent: costBasis > 0 ? (pnl / costBasis) * 100 : 0
                    };
                });
                
                return {
                    investedValue,
                    totalCostBasis,
                    totalPnL: investedValue - totalCostBasis,
                    assets
                };
            };

            // --- Fetchers ---
            const fetchOverview = async () => {
                if (!apiKey || !checkRateLimit()) return;
                setIsLoading(true);
                try {
                    const headers = getHeaders();
                    const [coinsRes, hopiumRes] = await Promise.all([
                        fetch(getUrl('https://rugplay.com/api/v1/top'), { headers }),
                        fetch(getUrl('https://rugplay.com/api/v1/hopium?status=ACTIVE&limit=20'), { headers })
                    ]);

                    if (coinsRes.status === 401 || hopiumRes.status === 401) throw new Error("Unauthorized: API Key rejected.");
                    
                    const coinsJson = coinsRes.ok ? await coinsRes.json() : { coins: [] };
                    setMarketData(coinsJson.coins || []);

                    const hopiumJson = hopiumRes.ok ? await hopiumRes.json() : { questions: [] };
                    setPredictionMarkets(hopiumJson.questions || []);
                    
                    setError(null); 
                } catch (err) {
                    console.error("Fetch error:", err);
                    setError(err.message.includes('Failed to fetch') ? "Network Error. Check Proxy." : err.message);
                    setShowErrorModal(true);
                } finally {
                    setIsLoading(false);
                }
            };

            const fetchDetails = async (item, type) => {
                if (!apiKey || !checkRateLimit()) return;
                setSelectedItem({ ...item, type });
                setIsDetailLoading(true);
                setChartData([]); 
                setAnalysisResult(null); 

                try {
                    const headers = getHeaders();
                    let history = [];

                    if (type === 'coin') {
                        const res = await fetch(getUrl(`https://rugplay.com/api/v1/coin/${item.symbol}?timeframe=1h`), { headers });
                        if (!res.ok) throw new Error(`Error: ${res.status}`);
                        const data = await res.json();
                        
                        const smaPeriod = 5;
                        if (data.candlestickData) {
                            history = data.candlestickData.map((c, i, arr) => {
                                const volItem = data.volumeData ? data.volumeData.find(v => v.time === c.time) : null;
                                let sma = null;
                                if (i >= smaPeriod - 1) {
                                    const sum = arr.slice(i - (smaPeriod - 1), i + 1).reduce((acc, curr) => acc + curr.close, 0);
                                    sma = sum / smaPeriod;
                                }
                                return {
                                    time: new Date(c.time * 1000).toLocaleTimeString([], { hour: '2-digit', minute:'2-digit' }),
                                    value: c.close, open: c.open, high: c.high, low: c.low, 
                                    volume: volItem ? volItem.volume : 0, 
                                    sma: sma,
                                    trend: c.close >= c.open ? 'up' : 'down'
                                };
                            });
                        }
                        analyzeTarget(data.coin || item, 'coin');
                    } else {
                        const res = await fetch(getUrl(`https://rugplay.com/api/v1/hopium/${item.id}`), { headers });
                        if (!res.ok) throw new Error(`Error: ${res.status}`);
                        const data = await res.json();
                        if (data.probabilityHistory) {
                            history = data.probabilityHistory.map((p, index, arr) => {
                                const prev = arr[index - 1];
                                return {
                                    time: new Date(p.time * 1000).toLocaleTimeString([], { hour: '2-digit', minute:'2-digit' }),
                                    value: p.value, volume: prev ? Math.abs(p.value - prev.value) * 1000 : 0, trend: prev && p.value >= prev.value ? 'up' : 'down'
                                };
                            });
                        }
                        analyzeTarget(data.question || item, 'prediction');
                    }
                    setChartData(history);
                } catch (err) {
                    setError(err.message);
                    setShowErrorModal(true);
                } finally {
                    setIsDetailLoading(false);
                }
            };

            useEffect(() => {
                if (apiKey) {
                    fetchOverview();
                    const interval = setInterval(fetchOverview, 60000); 
                    return () => clearInterval(interval);
                }
            }, [apiKey]);

            const runAiAnalysis = async () => {
                if (!selectedItem || !checkRateLimit()) return;
                if (!geminiKey) {
                    setError("Please enter your Gemini API Key in the header.");
                    setShowErrorModal(true);
                    return;
                }
                
                setIsAiLoading(true);
                try {
                    const type = selectedItem.type === 'coin' ? 'crypto coin' : 'prediction market';
                    const contextData = { item: selectedItem, recentChart: chartData.slice(-5) };
                    const prompt = `Analyze this game ${type} data as a cynical trader. Data: ${JSON.stringify(contextData)}. CRITICAL: The 'prediction' field must be ONE WORD ONLY: "BUY", "SELL", "YES", or "NO". Output JSON: { "sentiment": "Bullish"|"Bearish"|"Neutral", "riskScore": 0-100, "prediction": "BUY/SELL/YES/NO", "details": "Witty sentence max 15 words." }`;

                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${geminiKey}`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } })
                    });

                    if (!response.ok) throw new Error(`AI Oracle failed: ${response.status}`);
                    const result = await response.json();
                    const aiData = JSON.parse(result.candidates[0].content.parts[0].text);

                    setAnalysisResult({
                        target: selectedItem.name || selectedItem.question || selectedItem.symbol,
                        type: selectedItem.type === 'coin' ? 'Token Analysis' : 'Hopium Analysis',
                        sentiment: aiData.sentiment,
                        riskScore: aiData.riskScore,
                        prediction: aiData.prediction.toUpperCase(),
                        confidence: 99,
                        details: aiData.details,
                        isWhale: false,
                        isAi: true
                    });
                    setShowResultModal(true);
                } catch (err) {
                    setError(err.message);
                    setShowErrorModal(true);
                } finally {
                    setIsAiLoading(false);
                }
            };

            const analyzeTarget = (data, type) => {
                const isCoin = type === 'coin';
                let prediction = "NEUTRAL";
                let sentiment = "Neutral";
                let riskScore = 50;
                let details = "Insufficient data.";
                let isWhale = false;

                if (isCoin) {
                    const vol = data.volume24h || 0;
                    const change = data.change24h || 0;
                    const mcap = data.marketCap || 0;
                    if (vol > (mcap * 0.1) && vol > 10000) isWhale = true;
                    riskScore = Math.min(99, (Math.abs(change) / 10) + (mcap < 10000 ? 50 : 0));
                    if (change > 20) { sentiment = "Bullish"; prediction = "BUY"; details = "Strong momentum."; } 
                    else if (change < -15) { sentiment = "Bearish"; prediction = "SELL"; details = "Dumping hard."; } 
                    else { sentiment = "Neutral"; prediction = "HOLD"; details = "Consolidating."; }
                } else {
                    const yes = data.yesPercentage || 50;
                    if (yes > 85) { sentiment = "Bullish"; prediction = "YES"; details = "High probability."; } 
                    else if (yes < 15) { sentiment = "Bearish"; prediction = "NO"; details = "Unlikely."; } 
                    else { sentiment = "Uncertain"; prediction = "UNSURE"; details = "Too close to call."; }
                }

                setAnalysisResult({
                    target: isCoin ? (data.name || data.symbol) : "Market Question",
                    type: isCoin ? 'Token Analysis' : 'Hopium Analysis',
                    sentiment, riskScore: Math.floor(riskScore), prediction, confidence: 75, details, isWhale, isAi: false
                });
            };

            const getProcessedList = () => {
                let list = activeTab === 'dashboard' ? [...marketData] : 
                           activeTab === 'predictions' ? [...predictionMarkets] : 
                           activeTab === 'watchlist' ? marketData.filter(c => watchlist.includes(c.symbol)) : 
                           [];

                if (activeTab === 'portfolio') return [];

                if (searchQuery) {
                    list = list.filter(item => (item.name || item.question || item.symbol || '').toLowerCase().includes(searchQuery.toLowerCase()));
                }
                
                if (sortOption === 'gainers') list.sort((a, b) => (Number(b.change24h || 0) - Number(a.change24h || 0)));
                else if (sortOption === 'losers') list.sort((a, b) => (Number(a.change24h || 0) - Number(b.change24h || 0)));
                else if (sortOption === 'volume') list.sort((a, b) => (Number(b.volume24h || b.totalAmount || 0) - Number(a.volume24h || a.totalAmount || 0)));

                return list;
            };

            const CustomTooltip = ({ active, payload }) => {
                if (active && payload && payload.length) {
                    const data = payload[0].payload;
                    return (
                        <div className="bg-slate-900 border border-slate-700 p-3 rounded-lg shadow-xl text-xs space-y-1">
                            <div className="font-bold text-slate-300 mb-2">{data.time}</div>
                            <div className="flex justify-between gap-4"><span className="text-slate-500">Price:</span> <span className="font-mono text-white">${Number(data.value).toFixed(2)}</span></div>
                            {data.sma && <div className="flex justify-between gap-4"><span className="text-purple-400">SMA:</span> <span className="font-mono text-purple-300">${Number(data.sma).toFixed(2)}</span></div>}
                            <div className="flex justify-between gap-4 border-t border-slate-800 pt-1 mt-1"><span className="text-slate-500">Vol:</span> <span className="font-mono text-amber-400">{Math.floor(data.volume).toLocaleString()}</span></div>
                        </div>
                    );
                }
                return null;
            };

            const ListItem = ({ item, type }) => {
                const isCoin = type === 'coin';
                const id = isCoin ? item.symbol : item.id;
                const isWatched = watchlist.includes(id);
                return (
                    <div onClick={() => fetchDetails(item, type)} className={`px-6 py-4 flex items-center justify-between cursor-pointer transition-colors border-l-2 border-transparent hover:bg-slate-800/50 ${selectedItem?.symbol === item.symbol || selectedItem?.id === item.id ? 'bg-indigo-500/10 border-indigo-500' : ''}`}>
                        <div className="flex items-center gap-3">
                            <button onClick={(e) => toggleWatchlist(e, id)} className="text-slate-600 hover:text-amber-400 transition-colors"><Star size={16} fill={isWatched ? "#fbbf24" : "none"} className={isWatched ? "text-amber-400" : ""} /></button>
                            {isCoin ? (
                                <>
                                    <div className="w-8 h-8 rounded-full bg-slate-800 flex items-center justify-center text-xs font-bold text-slate-300">{item.symbol[0]}</div>
                                    <div><div className="font-bold text-slate-200">{item.symbol}</div><div className="text-xs text-slate-500">{item.name}</div></div>
                                </>
                            ) : (
                                <div><div className="font-bold text-slate-200 text-sm line-clamp-1 max-w-[180px]">{item.question}</div><div className="text-xs text-slate-500 flex items-center gap-2"><span>YES {item.yesPercentage}%</span></div></div>
                            )}
                        </div>
                        <div className="text-right min-w-[80px]">
                            {isCoin ? (
                                <><div className="font-mono text-slate-200">${Number(item.price || item.currentPrice).toFixed(2)}</div><div className={`text-xs font-bold ${Number(item.change24h) >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>{Number(item.change24h) > 0 ? '+' : ''}{Number(item.change24h).toFixed(2)}%</div></>
                            ) : <div className="text-xs font-mono text-slate-400">#{item.id}</div>}
                        </div>
                    </div>
                );
            };

            const TurnstileWidget = ({ onVerify }) => {
                const containerRef = useRef(null);
                useEffect(() => { if (containerRef.current && window.turnstile) window.turnstile.render(containerRef.current, { sitekey: TURNSTILE_SITE_KEY, callback: onVerify }); }, []);
                return <div ref={containerRef} className="my-4"></div>;
            };

            const processedList = getProcessedList();
            const chartColors = chartData.length < 2 ? { stroke: '#6366f1' } : (chartData[chartData.length-1].value >= chartData[0].value ? { stroke: '#10b981' } : { stroke: '#f43f5e' });
            
            const portfolioStats = getPortfolioStats();
            
            // Asset Allocation for Pie Chart
            const allocationData = portfolioStats.assets.map((asset, index) => ({
                name: asset.symbol,
                value: asset.value,
                color: COLORS[index % COLORS.length]
            }));

            return (
                <div className="min-h-screen bg-slate-950 text-slate-200 font-sans p-4 md:p-8 relative">
                    <DeploymentBanner />
                    <NewsTicker />
                    
                    {/* ONBOARDING MODAL */}
                    {showOnboarding && <OnboardingModal onComplete={handleOnboardingComplete} />}

                    {/* TURNSTILE MODAL */}
                    {showTurnstile && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center bg-slate-950/95 backdrop-blur-md p-4 animate-in fade-in duration-300">
                            <div className="bg-slate-900 border border-indigo-500 p-8 rounded-2xl max-w-sm w-full text-center shadow-2xl">
                                <ShieldCheck size={48} className="text-indigo-500 mx-auto mb-4" /><h3 className="text-2xl font-bold text-white mb-2">Security Check</h3>
                                <div className="flex justify-center"><TurnstileWidget onVerify={handleTurnstileSuccess} /></div>
                            </div>
                        </div>
                    )}

                    {/* RESULT MODAL */}
                    {showResultModal && analysisResult && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 animate-in fade-in duration-200">
                            <div className={`border p-8 rounded-2xl max-w-lg w-full relative shadow-2xl animate-in zoom-in-95 duration-300 ${analysisResult.isAi ? 'bg-indigo-950/90 border-indigo-400 shadow-indigo-500/50' : 'bg-slate-900 border-indigo-500/50 shadow-indigo-500/20'}`}>
                                <button onClick={() => setShowResultModal(false)} className="absolute top-4 right-4 text-slate-500 hover:text-white"><X size={24} /></button>
                                <div className="flex flex-col items-center text-center space-y-6">
                                    <div className="relative">
                                        <div className={`w-20 h-20 rounded-full flex items-center justify-center border-2 ${analysisResult.isAi ? 'bg-indigo-500 text-white border-white animate-pulse' : 'bg-indigo-500/20 text-indigo-400 border-indigo-500'}`}>{analysisResult.isAi ? <Sparkles size={40} /> : <Brain size={40} />}</div>
                                        {analysisResult.isWhale && <div className="absolute -top-2 -right-2 bg-amber-500 text-slate-900 text-[10px] font-bold px-2 py-1 rounded-full animate-bounce">WHALE!</div>}
                                    </div>
                                    <div><div className="text-sm font-bold text-indigo-400 uppercase tracking-widest mb-2 flex items-center justify-center gap-2">{analysisResult.isAi ? <>✨ AI GENERATED ✨</> : analysisResult.type + " COMPLETE"}</div><h2 className="text-3xl font-black text-white">{analysisResult.target}</h2></div>
                                    <div className="w-full bg-slate-800/50 rounded-xl p-6 border border-slate-700">
                                        <div className="text-sm text-slate-400 mb-1">PREDICTION</div>
                                        <div className={`text-4xl font-black mb-4 ${['YES', 'BUY'].includes(analysisResult.prediction) ? 'text-emerald-400' : ['NO', 'SELL'].includes(analysisResult.prediction) ? 'text-rose-400' : 'text-amber-400'}`}>{analysisResult.prediction}</div>
                                        <p className={`text-slate-300 italic ${analysisResult.isAi ? 'font-serif text-lg text-indigo-200' : ''}`}>"{analysisResult.details}"</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* ERROR MODAL */}
                    {showErrorModal && error && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/90 p-4 animate-in fade-in duration-200">
                            <div className="bg-rose-950/90 border border-rose-500 p-8 rounded-2xl max-w-md w-full relative shadow-2xl shadow-rose-900/50 animate-in shake duration-300">
                                <button onClick={() => setShowErrorModal(false)} className="absolute top-4 right-4 text-rose-300 hover:text-white"><X size={24} /></button>
                                <div className="flex flex-col items-center text-center">
                                    <AlertTriangle size={48} className="text-rose-500 mb-4" />
                                    <h3 className="text-xl font-bold text-white mb-2">System Alert</h3>
                                    <p className="text-rose-200 mb-6 text-sm">{error}</p>
                                    <button onClick={() => setShowErrorModal(false)} className="bg-rose-600 hover:bg-rose-500 text-white font-bold py-2 px-4 rounded-lg">Close</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* HEADER */}
                    <header className="max-w-7xl mx-auto my-8 flex flex-col md:flex-row justify-between items-center gap-4">
                        <div className="flex items-center gap-3">
                            <div className="bg-indigo-600 p-2 rounded-lg"><Activity className="text-white" size={24} /></div>
                            <div><h1 className="text-2xl font-bold bg-gradient-to-r from-indigo-400 to-cyan-400 bg-clip-text text-transparent">Rugplay Analytics</h1><p className="text-slate-500 text-xs uppercase tracking-wider">v5.0 TRACKER</p></div>
                        </div>
                        <div className="flex flex-col sm:flex-row items-center gap-2 bg-slate-900 p-2 rounded-lg border border-slate-800">
                            <div className="flex items-center gap-3 px-4 py-2 bg-slate-950/80 rounded border border-slate-700">
                                <Wallet size={16} className="text-emerald-400" />
                                <div className="text-sm font-mono text-emerald-400">${portfolioStats.investedValue.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} <span className="text-slate-500 text-xs">ASSETS</span></div>
                                <div className={`text-xs border-l border-slate-700 pl-3 ${portfolioStats.totalPnL >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>PnL: {portfolioStats.totalPnL >= 0 ? '+' : ''}${portfolioStats.totalPnL.toFixed(2)}</div>
                            </div>
                            <div className="flex items-center gap-2 px-3 bg-slate-950/50 rounded h-10 w-full sm:w-auto border border-slate-800">
                                <Key size={14} className={apiKey ? "text-emerald-400" : "text-slate-500"} />
                                <input type="password" placeholder="Rugplay Key" value={apiKey} onChange={(e) => setApiKey(e.target.value)} className="bg-transparent border-none text-xs focus:ring-0 w-24 text-slate-300" />
                            </div>
                            <div className="flex items-center gap-2 px-3 bg-slate-950/50 rounded h-10 w-full sm:w-auto border border-slate-800">
                                <Cpu size={14} className={geminiKey ? "text-indigo-400" : "text-slate-500"} />
                                <input type="password" placeholder="Gemini Key" value={geminiKey} onChange={(e) => setGeminiKey(e.target.value)} className="bg-transparent border-none text-xs focus:ring-0 w-24 text-slate-300" />
                            </div>
                            <button onClick={fetchOverview} disabled={isLoading || !apiKey} className="p-2 h-10 w-10 flex items-center justify-center hover:bg-slate-800 rounded-md text-slate-400 hover:text-white transition-colors disabled:opacity-50"><RefreshCw size={16} className={isLoading ? "animate-spin" : ""} /></button>
                        </div>
                    </header>

                    {/* MAIN */}
                    <main className="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6">
                        {/* LEFT COL */}
                        <div className="lg:col-span-2 space-y-6">
                            <div className="flex flex-col md:flex-row gap-4 items-center justify-between bg-slate-900/50 p-2 rounded-xl">
                                <div className="flex gap-2 w-full md:w-auto">
                                    {['dashboard', 'predictions', 'watchlist', 'portfolio'].map(tab => (
                                        <button key={tab} onClick={() => { setActiveTab(tab); setSelectedItem(null); setChartData([]); }} className={`px-4 py-2 rounded-lg text-xs font-bold uppercase transition-colors flex-1 md:flex-none ${activeTab === tab ? 'bg-indigo-600 text-white shadow-lg' : 'text-slate-500 hover:text-slate-300 hover:bg-slate-800'}`}>{tab === 'dashboard' ? 'Coins' : tab}</button>
                                    ))}
                                </div>
                                <div className="flex gap-2 w-full md:w-auto">
                                    <div className="relative flex-1 md:flex-none">
                                        <Search size={14} className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500" />
                                        <input type="text" placeholder="Search..." value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} className="w-full md:w-40 bg-slate-950 border border-slate-800 rounded-lg pl-9 pr-3 py-1.5 text-xs text-slate-200 focus:border-indigo-500 focus:ring-0" />
                                    </div>
                                    <div className="relative">
                                        <div className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500 pointer-events-none"><ArrowUpDown size={14} /></div>
                                        <select value={sortOption} onChange={(e) => setSortOption(e.target.value)} className="bg-slate-950 border border-slate-800 rounded-lg pl-9 pr-8 py-1.5 text-xs text-slate-200 focus:border-indigo-500 focus:ring-0 appearance-none cursor-pointer">
                                            <option value="default">Default</option><option value="gainers">Top Gainers</option><option value="losers">Top Losers</option><option value="volume">High Volume</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div className="bg-slate-900 rounded-xl border border-slate-800 overflow-hidden max-h-[600px] overflow-y-auto">
                                {activeTab === 'portfolio' ? (
                                    <div className="space-y-6 p-6">
                                        {/* Summary Card */}
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div className="bg-slate-950/50 rounded-xl border border-slate-800 p-6 flex flex-col justify-center">
                                                <h3 className="text-slate-400 text-sm font-medium mb-1">Total Asset Value</h3>
                                                <div className="text-3xl font-bold text-white">${portfolioStats.investedValue.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                                                <div className={`text-sm mt-2 ${portfolioStats.totalPnL >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>
                                                    {portfolioStats.totalPnL >= 0 ? '+' : ''}${portfolioStats.totalPnL.toFixed(2)} Unrealized PnL
                                                </div>
                                                <div className="flex gap-2 mt-4">
                                                    <button onClick={resetPortfolio} className="bg-rose-500/10 text-rose-400 hover:bg-rose-500/20 px-3 py-1.5 rounded text-xs font-bold transition-colors">Reset History</button>
                                                </div>
                                            </div>
                                            
                                            <div className="bg-slate-950/50 rounded-xl border border-slate-800 p-6 flex items-center gap-6">
                                                <div className="h-24 w-24 relative">
                                                     <ResponsiveContainer width="100%" height="100%">
                                                        <PieChart>
                                                            <Pie data={allocationData} dataKey="value" innerRadius={25} outerRadius={40} stroke="none">
                                                                {allocationData.map((entry, index) => (
                                                                    <Cell key={`cell-${index}`} fill={entry.color} />
                                                                ))}
                                                            </Pie>
                                                        </PieChart>
                                                    </ResponsiveContainer>
                                                    <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                                                        <Wallet size={16} className="text-slate-500" />
                                                    </div>
                                                </div>
                                                <div className="flex-1 space-y-2">
                                                    <div className="text-xs text-slate-500 font-bold uppercase tracking-wider mb-2">Top Holdings</div>
                                                    {portfolioStats.assets.slice(0, 3).map((asset, i) => (
                                                        <div key={asset.symbol} className="flex justify-between items-center text-xs">
                                                            <div className="flex items-center gap-2"><div className="w-2 h-2 rounded-full" style={{backgroundColor: COLORS[i % COLORS.length]}}></div><span className="text-slate-300">{asset.symbol}</span></div>
                                                            <span className="font-mono text-slate-400">${asset.value.toFixed(0)}</span>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>

                                        {/* Holdings List */}
                                        <div className="bg-slate-950/50 rounded-xl border border-slate-800 overflow-hidden">
                                            <div className="px-6 py-3 bg-slate-900 text-xs font-bold text-slate-500 flex justify-between">
                                                <span>ASSET</span>
                                                <div className="flex gap-8 text-right">
                                                    <span className="w-20">AVG BUY</span>
                                                    <span className="w-20">PRICE</span>
                                                    <span className="w-24">VALUE</span>
                                                </div>
                                            </div>
                                            <div className="divide-y divide-slate-800">
                                                {portfolioStats.assets.length === 0 ? (
                                                    <div className="p-8 text-center text-slate-500 text-sm">No assets tracked. Log trades in Dashboard.</div>
                                                ) : (
                                                    portfolioStats.assets.map(asset => (
                                                        <div key={asset.symbol} className="px-6 py-4 flex items-center justify-between hover:bg-slate-800/30 transition-colors">
                                                            <div className="flex items-center gap-3">
                                                                <div className="w-8 h-8 rounded-full bg-slate-800 flex items-center justify-center text-xs font-bold text-slate-300">{asset.symbol[0]}</div>
                                                                <div>
                                                                    <div className="font-bold text-slate-200">{asset.symbol}</div>
                                                                    <div className="text-xs text-slate-500">{asset.qty.toFixed(4)} Coins</div>
                                                                </div>
                                                            </div>
                                                            <div className="flex gap-8 text-right text-sm">
                                                                <div className="w-20 font-mono text-slate-400">${asset.avgCost.toFixed(2)}</div>
                                                                <div className="w-20 font-mono text-slate-200">${asset.currentPrice.toFixed(2)}</div>
                                                                <div className="w-24">
                                                                    <div className="font-mono text-white">${asset.value.toFixed(2)}</div>
                                                                    <div className={`text-xs ${asset.pnl >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>
                                                                        {asset.pnl >= 0 ? '+' : ''}{asset.pnl.toFixed(2)} ({asset.pnlPercent.toFixed(1)}%)
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    ))
                                                )}
                                            </div>
                                        </div>

                                        {/* TRANSACTION HISTORY */}
                                        <div className="bg-slate-950/50 rounded-xl border border-slate-800 overflow-hidden">
                                            <div className="px-6 py-3 bg-slate-900 text-xs font-bold text-slate-500 flex justify-between items-center">
                                                <span className="flex items-center gap-2"><History size={14}/> TRADE HISTORY</span>
                                                <button onClick={() => setTransactions([])} className="text-slate-600 hover:text-rose-400"><Trash2 size={12}/></button>
                                            </div>
                                            <div className="divide-y divide-slate-800 max-h-60 overflow-y-auto">
                                                {transactions.length === 0 ? (
                                                    <div className="p-4 text-center text-xs text-slate-500">No trading history yet.</div>
                                                ) : (
                                                    transactions.map(tx => (
                                                        <div key={tx.id} className="px-6 py-3 flex items-center justify-between hover:bg-slate-800/30 text-xs">
                                                            <div className="flex items-center gap-4">
                                                                <span className="text-slate-500 font-mono w-24">{tx.timestamp.split(',')[1]}</span>
                                                                <span className={`font-bold w-10 ${tx.type === 'BUY' ? 'text-emerald-400' : 'text-rose-400'}`}>{tx.type}</span>
                                                                <span className="text-white font-bold">{tx.symbol}</span>
                                                            </div>
                                                            <div className="flex gap-6 text-right">
                                                                <span className="text-slate-400 w-20">@ ${tx.price.toFixed(2)}</span>
                                                                <span className="text-white font-mono w-20">${tx.amount.toFixed(2)}</span>
                                                            </div>
                                                        </div>
                                                    ))
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                ) : (
                                    activeTab === 'watchlist' ? (
                                        <div className="divide-y divide-slate-800">
                                            <div className="px-6 py-3 bg-indigo-500/10 text-xs font-bold text-indigo-400">WATCHED COINS</div>
                                            {processedList.coins.length === 0 && <div className="p-4 text-center text-xs text-slate-600">No coins starred yet.</div>}
                                            {processedList.coins.map(c => <ListItem key={c.symbol} item={c} type="coin" />)}
                                            <div className="px-6 py-3 bg-indigo-500/10 text-xs font-bold text-indigo-400 border-t border-slate-800">WATCHED PREDICTIONS</div>
                                            {processedList.preds.length === 0 && <div className="p-4 text-center text-xs text-slate-600">No predictions starred yet.</div>}
                                            {processedList.preds.map(p => <ListItem key={p.id} item={p} type="prediction" />)}
                                        </div>
                                    ) : (
                                        <div className="divide-y divide-slate-800">
                                            {activeTab === 'dashboard' && (<div className="px-6 py-3 bg-slate-950/50 text-xs font-semibold text-slate-500 flex justify-between sticky top-0 backdrop-blur-sm z-10"><span>ASSET</span><div className="flex gap-8"><span className="w-24 text-right">PRICE</span><span className="w-20 text-right">24H</span></div></div>)}
                                            {processedList.length === 0 ? (<div className="p-12 text-center text-slate-500 text-sm flex flex-col items-center gap-2"><Search size={32} className="opacity-20" />{!apiKey ? "Enter API Key to load data." : "No results found matching your filters."}</div>) : (processedList.map((item) => (<ListItem key={activeTab === 'dashboard' ? item.symbol : item.id} item={item} type={activeTab === 'dashboard' ? 'coin' : 'prediction'} />)))}
                                        </div>
                                    )
                                )}
                            </div>
                        </div>

                        {/* RIGHT COL: ORACLE & TRADE */}
                        <div className="lg:col-span-1">
                            <div className="bg-slate-900 rounded-xl border border-slate-800 h-full sticky top-8 flex flex-col">
                                <div className="p-6 border-b border-slate-800 bg-slate-800/30 flex justify-between items-center">
                                    <div className="flex items-center gap-2 mb-1"><Brain className="text-indigo-400" size={20} /><h2 className="font-bold text-slate-100">Market Oracle</h2></div>
                                    {selectedItem && selectedItem.type === 'coin' && (
                                        <span className="text-xs bg-emerald-500/20 text-emerald-400 px-2 py-1 rounded">Holding: {holdings[selectedItem.symbol]?.qty ? holdings[selectedItem.symbol].qty.toFixed(4) : 0}</span>
                                    )}
                                </div>
                                <div className="p-6 flex-1 flex flex-col">
                                    {!analysisResult ? (
                                        <div className="flex-1 flex flex-col items-center justify-center text-slate-600 space-y-4 py-12">
                                            <Zap size={48} className="opacity-20" /><p className="text-sm text-center max-w-[200px]">Select item to analyze & trade.</p>
                                        </div>
                                    ) : (
                                        <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
                                            <div className="flex justify-between items-start">
                                                <div><span className="text-xs font-bold text-indigo-400 uppercase tracking-widest">{analysisResult.type}</span><h3 className="text-lg font-bold text-white mt-1">{analysisResult.target}</h3></div>
                                                <button onClick={runAiAnalysis} disabled={isAiLoading} className={`text-xs px-3 py-1.5 rounded-lg flex items-center gap-1.5 font-bold transition-all ${isAiLoading ? "bg-indigo-500/20" : "bg-gradient-to-r from-indigo-500 to-purple-600 text-white shadow-lg"}`}>{isAiLoading ? <RefreshCw size={12} className="animate-spin" /> : <Sparkles size={12} />}{isAiLoading ? "SCAN" : "AI SCAN"}</button>
                                            </div>
                                            
                                            {/* CHART */}
                                            {isDetailLoading ? (<div className="h-40 bg-slate-950 rounded-lg flex items-center justify-center"><RefreshCw className="animate-spin text-slate-600" /></div>) : (
                                                <div className="h-48 bg-slate-950 rounded-lg border border-slate-800 overflow-hidden relative">
                                                    {chartData.length > 0 ? (
                                                        <ResponsiveContainer width="100%" height="100%">
                                                            <ComposedChart data={chartData}>
                                                                <defs><linearGradient id="chartColor" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor={chartColors.stroke} stopOpacity={0.3}/><stop offset="95%" stopColor={chartColors.stroke} stopOpacity={0}/></linearGradient></defs>
                                                                <Tooltip content={<CustomTooltip />} />
                                                                <YAxis yAxisId="right" orientation="right" hide />
                                                                <Bar yAxisId="right" dataKey="volume" fill="#475569" opacity={0.3} barSize={2} />
                                                                <YAxis yAxisId="left" hide domain={['auto', 'auto']} />
                                                                <Area yAxisId="left" type="monotone" dataKey="value" stroke={chartColors.stroke} strokeWidth={2} fill="url(#chartColor)" isAnimationActive={false} />
                                                                <Line yAxisId="left" type="monotone" dataKey="sma" stroke="#a855f7" strokeWidth={1} dot={false} />
                                                            </ComposedChart>
                                                        </ResponsiveContainer>
                                                    ) : (<div className="flex items-center justify-center h-full text-xs text-slate-600">No chart data</div>)}
                                                </div>
                                            )}

                                            {/* RUG-O-METER */}
                                            <div className="bg-slate-950 rounded-lg p-4 border border-slate-800">
                                                <div className="flex justify-between items-center mb-2">
                                                    <span className="text-slate-400 text-sm">Rug Probability</span>
                                                    <span className={`font-mono text-sm ${analysisResult.riskScore > 70 ? 'text-rose-400' : 'text-emerald-400'}`}>{analysisResult.riskScore}%</span>
                                                </div>
                                                <div className="w-full bg-slate-800 h-2 rounded-full overflow-hidden">
                                                    <div className={`h-full transition-all duration-1000 ${analysisResult.riskScore > 70 ? 'bg-rose-500' : analysisResult.riskScore > 40 ? 'bg-amber-500' : 'bg-emerald-500'}`} style={{width: `${analysisResult.riskScore}%`}}></div>
                                                </div>
                                            </div>

                                            {/* PREDICTION */}
                                            <div className="bg-slate-800/50 p-4 rounded-lg border border-slate-700/50 flex items-center justify-between">
                                                <div><div className="text-xs text-slate-400">ORACLE SAYS</div><div className="text-xl font-bold text-white">{analysisResult.prediction}</div></div>
                                                <div className="text-right max-w-[150px]"><p className="text-xs text-slate-400 italic">"{analysisResult.details}"</p></div>
                                            </div>

                                            {/* TRADING INTERFACE */}
                                            {selectedItem && selectedItem.type === 'coin' && (
                                                <div className="grid grid-cols-2 gap-3 pt-2 border-t border-slate-800">
                                                    <div className="col-span-2 relative">
                                                        <div className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500"><DollarSign size={14}/></div>
                                                        <input type="number" placeholder="Enter Amount (USD)" value={tradeAmount} onChange={(e) => setTradeAmount(e.target.value)} className="w-full bg-slate-950 border border-slate-800 rounded-lg pl-8 pr-3 py-2 text-sm text-white focus:border-indigo-500 focus:ring-0" />
                                                    </div>
                                                    <button onClick={() => executeTrade('BUY')} className="bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-2 rounded-lg transition-colors">LOG BUY</button>
                                                    <button onClick={() => executeTrade('SELL')} className="bg-rose-600 hover:bg-rose-500 text-white font-bold py-2 rounded-lg transition-colors">LOG SELL</button>
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        try {
            root.render(<RugplayAnalyzer />);
        } catch (e) {
            console.error("Critical Render Error:", e);
            document.body.innerHTML = '<div style="color:red; padding:20px;">Critical Error: Failed to render app. Check console.</div>';
        }
    </script>
</body>
</html>
